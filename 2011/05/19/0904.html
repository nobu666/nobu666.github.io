<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:400,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/skeleton.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Real Beat">
<title>さくらのVPSでCentOSからUbuntuに鞍替えまとめ - Real Beat</title>
</head>
<body>

<div class="container">

	<header role="banner">
		<div class="header-logo">
			<a href="/"><img src="https://avatars0.githubusercontent.com/u/51591?v=3&amp;s=460" width="60" height="60"></a>
		</div>
		
	</header>


	<main role="main">
		<article itemscope itemtype="http://schema.org/BlogPosting">
			<h1 class="entry-title" itemprop="headline">さくらのVPSでCentOSからUbuntuに鞍替えまとめ</h1>
			<span class="entry-meta"><time itemprop="datePublished" datetime="2011-05-19">May 19, 2011</time></span>
			<section itemprop="entry-text">
				<p><a href="http://twitter.com/maccha">@maccha</a>からリクエストがあったので、適当にまとめました。タイトルの通りです。</p>

<p><h2>OS再インストールの準備</h2>
リモートコンソールの起動にJDK必須なので、作業するマシンにJDKが入ってなければいれとく。あとはTightVNCとか、必要ならどうぞ。あとバックアップ忘れずに。とりあえずwordpressだけ動いてる状態だったので</p>

<pre><code>$ mysqldump -uroot -p wp -Q -c --opt &amp;gt; dumpfile
$ tar zcvf wordpress.tar.gz /var/www/wordpress
$ tar zcvf ssh.tar.gz ~/.ssh
</code></pre>

<p>みたいな感じでバックアップ取って作業マシンにscpなりlftpなりで持ってきておく。必要なら/etc/my.cnfとか/etc/php.iniとか、ホームのドットファイル類も。</p>

<p><h2>OS再インストール</h2>
VPSコントロールパネルにログインして、OS再インストール→カスタムOSインストール→ubuntu 10.04 amd64を選択→<a href="http://support.sakura.ad.jp/support/vps/menu_oscustom_ubuntu.shtml">カスタムOSインストールガイド ： Ubuntu 10.04</a>の通り進める。10分くらいありゃ終わる。</p>

<p><h2>SSHの設定</h2>
何はともあれrootのパスワードとSSHの設定をリモートコンソールからやる。scpなりで、バックアップファイルを転送しとくこと。</p>

<pre><code>$ sudo passwd
$ tar zxf wordpress.tar.gz
$ tar zxf ssh.tar.gz
$ chmod 700 .ssh
$ chmod 600 .ssh/*
$ sudo vi /etc/ssh/sshd_config
- Port 22
+ Port 適当なポート

- PermitRootLogin yes
+ PermitRootLogin no

- #PasswordAuthentication yes
+ PasswordAuthentication no
</code></pre>

<p>ポートは変えなくてもいいけどお好みで。ポート変えたら/etc/servicesのSSHのとこを合わせて変更するのも忘れずに。</p>

<pre><code>$ sudo sshd -t
</code></pre>

<p>でチェックして、エラーが出なければOKなので再起動</p>

<pre><code>$ sudo service ssh restart
</code></pre>

<p>ここで、もう一個ターミナル開いて問題なく接続できることを必ず確認。以降は普通に端末からSSHでつないで作業</p>

<p><h2>諸々設定</h2>
もうあとはお好みでどうぞなんだけど、最低やることだけ書いとく</p>

<pre><code>$ sudo apt-get update
.
.
.
$ sudo apt-get upgrade
.
.
.
$ sudo ufw status
Status: inactive
$ sudo ufw default deny
Default incoming policy changed to 'deny'
(be sure to update your rules accordingly)
$ sudo ufw allow SSHのポート番号
Rules updated
$ sudo ufw allow 80
Rules updated
$ sudo ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
$ sudo ufw status
Status: active
To                         Action      From
--                           ------      ----
SSHのポート番号   ALLOW       Anywhere
80                          ALLOW       Anywhere
$ sudo apt-get install denyhosts sysv-rc-conf build-essential zsh screen vim tmux curl wget git-core apache2 php5 libapache2-mod-php5 mysql-server php5-mysql #まぁこの辺は余計なのも入ってるのでお好きなように
$ sudo a2enmod rewrite # rewrite有効に
$ sudo vi /etc/apache2/sites-available/default #VirtualHostなりなんなり、お好きにどうぞ
$ sudo service apache2 restart
$ sudo sysv-rc-conf #自動起動したいやつを適当に選択
$ cp -a wordpress/* /var/www/wordpress #wordpressのバックアップ復元
$ mysql -uroot -p -e&amp;quot;create database wp&amp;quot; #とりあえずDBつくる
$ sudo cp my.cnf.backup /etc/my.cnf
$ sudo service mysql restart
$ mysql -uroot -p wp &amp;lt; dumpfile #dumpファイルからデータ復元
</code></pre>

<p>ここまでやればwordpressはもう普通に動いてるはず。あとはchshするなり、ドットファイル復元するなり、好きにすればいいかと。</p>

			</section>
		</article>
	</main>


	<footer role="contentinfo">
		<div class="hr"></div>
		<div class="footer-link">
			<a href="mailto:ogata.nobu@gmail.com" target="_blank">Email</a></span>
			<a href="https://twitter.com/nobu666" target="_blank">Twitter</a></span>
			<a href="https://www.facebook.com/nobutoshi.ogata" target="_blank">Facebook</a></span>
			<a href="https://github.com/nobu666" target="_blank">GitHub</a></span>
		</div>
		<div class="copyright">Copyright &copy; nobu666 All rights reserved.</div>
	</footer>

</div>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-57485-1', 'auto');
	ga('send', 'pageview');
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>