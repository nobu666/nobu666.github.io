<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Gentoo on Real Beat</title>
    <link>http://nobu666.com/categories/gentoo.html</link>
    <description>Recent content in Gentoo on Real Beat</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <copyright>&amp;copy; nobu666.com</copyright>
    <lastBuildDate>Thu, 03 Apr 2008 18:27:59 +0900</lastBuildDate>
    <atom:link href="http://nobu666.com/categories/gentoo.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>mixiとblogをそのまま同期させると、del.icio.usのdaily postがmixiでは役立たずになってウザそうだからどうにかする</title>
      <link>http://nobu666.com/2008/04/03/609.html</link>
      <pubDate>Thu, 03 Apr 2008 18:27:59 +0900</pubDate>
      
      <guid>http://nobu666.com/2008/04/03/609.html</guid>
      <description>&lt;p&gt;mixiにそのまま投稿しちゃうと、本来リンクじゃないと困るものが、ただのテキストになってしまうわけで。どっちみち携帯から見てる人には無用なエントリになっちゃうし、いっそのことmixiには投稿しないようにしようと。一番てっとり早いのはP::P::MixiDiary.pm内で、単純にif文でほげほげすることなんだけど。ちょっと気が向いたのでplugin初挑戦してみた。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-perl&#34;&gt;package Plagger::Plugin::Filter::StripDeliciousDailyPost;
use strict;
use base qw( Plagger::Plugin );

sub register {
    my($self, $context) = @_;
    $context-&amp;gt;register_hook(
        $self,
        &#39;update.entry.fixup&#39; =&amp;gt; \&amp;amp;filter,
    );
}

sub filter {
    my($self, $context, $args) = @_;

    my $title = $args-&amp;gt;{entry}-&amp;gt;title;
    for my $entry ($args-&amp;gt;{feed}-&amp;gt;entries) {
        if ($entry-&amp;gt;title =~ /^links for \d{4}-\d{2}-\d{2}$/i) {
            $context-&amp;gt;log(info =&amp;gt; &amp;quot;Delete Delicious daily post entry &amp;quot; . $entry-&amp;gt;link);
            $args-&amp;gt;{feed}-&amp;gt;delete_entry($entry);
        }
    }
}

1;
__END__
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;やはりperlは書き慣れんな。yamlを以下のようにして動作確認。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-perl&#34;&gt;plugins:
  - module: Subscription::Config
    config:
      feed:
        - url: http://nobu666.com/rss?feed=rss2
  - module: Filter::Rule
    rule:
      module: Deduped
      path: /tmp/blog2mixi.tmp
      compare_body: 1
  - module: Filter::Reverse
  - module: Filter::FindEnclosures
  - module: Filter::FetchEnclosure
    config:
      dir: /tmp/fetch-image
  - module: Filter::FormatText
  - module: Filter::EntryFullText
  - module: Filter::StripDeliciousDailyPost
  - module: Publish::MixiDiary
    config:
      username: メールアドレス
      password: パスワード
      interval: 10
      originally_link: 1

&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>[memo] 異なるアーキテクチャ間でクロスコンパイル</title>
      <link>http://nobu666.com/2006/11/19/449.html</link>
      <pubDate>Sun, 19 Nov 2006 23:27:30 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/11/19/449.html</guid>
      <description>&lt;h4&gt;前提条件&lt;/h4&gt;
基本的には&lt;a href=&#34;http://www.gentoo.org/doc/ja/distcc.xml&#34; target=&#34;_blank&#34;&gt;Gentoo distcc ドキュメント&lt;/a&gt;・&lt;a href=&#34;http://www.gentoo.org/doc/ja/cross-compiling-distcc.xml&#34; target=&#34;_blank&#34;&gt;DistCC クロスコンパイルガイド&lt;/a&gt;、この2つのドキュメントの通り行う。気をつけなきゃいけないのは、「資源を借りる側」と「資源を貸す側」で若干設定が異なる点。ここでは借りる側はi686(192.168.0.4)、貸す側はamd64(192.168.0.3)とする。

貸す側と借りる側で、gccのバージョンは同じであること。3.3.x同時はOKだが、3.3.xと3.2.xは混ぜないこと。

また、資源を借りる側は一方的に借りるだけで、相互に助け合わない設定とした。これは、貸す側はサーバなので24時間稼働しているが、借りる側はノートなのでそうした。

&lt;h4&gt;資源を貸す側の設定&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;emerge distcc crossdev
vi /etc/make.conf
 MAKEOPTS=&amp;quot;-j8&amp;quot; #(CPUの数+1)*2 ここは全体じゃなくてサーバ単体で計算すべきなのかも。詳細不明…もしかしたら-j6が当たりなのかも?
 FEATURES=&amp;quot;distcc&amp;quot;
 DISTCC_DIR=&amp;quot;/var/tmp/.distcc&amp;quot;
 PORTDIR_OVERLAY=&amp;quot;/usr/local/portage&amp;quot;
distcc-config --set-hosts &amp;quot;localhost 192.168.0.4&amp;quot;
vi /etc/conf.d/distccd
 DISTCCD_OPTS=&amp;quot;${DISTCCD_OPTS} --allow localhost --allow 192.168.0.4&amp;quot; #--allow 192.168.0.0/24でも可
/etc/init.d/distcc start
rc-update add distcc default
crossdev -t i686
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;資源を借りる側の設定&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;emerge distcc
vi /etc/make.conf
 MAKEOPTS=&amp;quot;-j8&amp;quot; #(CPUの数+1)*2
 FEATURES=&amp;quot;distcc&amp;quot;
 DISTCC_DIR=&amp;quot;/var/tmp/.distcc&amp;quot;
vi /etc/conf.d/distccd
 DISTCCD_OPTS=&amp;quot;${DISTCCD_OPTS} --allow localhost&amp;quot; #相互に助け合いたい場合は--allow 192.168.0.3を足すか--allow 192.168.0.0/24にする
cd /usr/lib/distcc/bin
rm c++ g++ gcc cc
echo &#39;#!/bin/bash&#39; &amp;gt; i686-pc-linux-gnu-wrapper
echo &#39;exec /usr/lib/distcc/bin/sparc-unknown-linux-gnu-${0##*/} &amp;quot;$@&amp;quot;&#39; &amp;gt;&amp;gt; i686-pc-linux-gnu-wrapper
chmod a+x i686-pc-linux-gnu-wrapper
ln -s i686-pc-linux-gnu-wrapper cc
ln -s i686-pc-linux-gnu-wrapper gcc
ln -s i686-pc-linux-gnu-wrapper g++
ln -s i686-pc-linux-gnu-wrapper c++
/etc/init.d/distcc start
rc-update add distcc default
export CC=&amp;quot;i686-pc-linux-gnu-gcc&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h4&gt;実際に試す&lt;/h4&gt;
借りる側から何か(それなりに時間のかかりそうなものを)emergeし、貸す側でtopコマンドで見てみる。distccというUSERでdistccやcc1というプロセスが見えれば成功している。当たり前だがコンパイルは速くなるが、configureやアーカイブのunpackは速くならないのであしからず。また、貸す側ではデフォルトでnice -15で実行されている。これは /etc/conf.d/distccdのDISTCCD_NICEで設定されているので、貸す側が暇なマシンなら変更してもいい。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo][Gentoo] SNMP&#43;RRDtool&#43;cactiでサーバ監視</title>
      <link>http://nobu666.com/2006/11/12/442.html</link>
      <pubDate>Sun, 12 Nov 2006 12:03:34 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/11/12/442.html</guid>
      <description>&lt;p&gt;インストールまでは上手くいったけど設定に嵌って酷い目にあった。&lt;/p&gt;

&lt;h4&gt;必要なものをインストールする&lt;/h4&gt;

&lt;p&gt;以下のものが必要。&lt;/p&gt;

&lt;ul&gt;
    &lt;li&gt;net-snmp&lt;/li&gt;
    &lt;li&gt;apache&lt;/li&gt;
    &lt;li&gt;php&lt;/li&gt;
    &lt;li&gt;mysql&lt;/li&gt;
    &lt;li&gt;rrdtool&lt;/li&gt;
    &lt;li&gt;cacti&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;さくっとemergeするわけだが、USEフラグに注意。cactiにはapache2/snmp、phpにはapache2/snmp/sockets/mysqlあたりが必要(gdとかxmlも必須なのか?よくわらかんがこの辺は/etc/make.confでデフォルトで付けている)。&lt;/p&gt;

&lt;h4&gt;初期設定&lt;/h4&gt;

&lt;p&gt;cacti用のデータベースとユーザを作成し、付属のスクリプトでテーブルを作成する。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysqladmin -u root create cacti -p
mysql cacti -u root -p &amp;gt; /var/www/localhost/htdocs/cacti/cacti.sql
mysql -u root mysql -p -e&amp;quot;GRANT ALL ON cacti.* TO cactiuser@localhost IDENTIFIED BY &#39;p4ssw0rd&#39;&amp;quot;
mysql -u root mysql -p -e&amp;quot;flush privileges&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;次にphpのconfigファイルを、今設定したものに合わせて書き換える。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;vi /var/www/localhost/htdocs/cacti/include/config.php
 $database_username = &amp;quot;cactiuser&amp;quot;;
 $database_password = &amp;quot;p4ssw0rd&amp;quot;;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;cron実行用のシステムアカウント作成とパーミッション変更&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;useradd -g apache -d /dev/null -s /bin/false -c cacti cacti
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ホームディレクトリを/dev/null、ログインシェルを/bin/falseにすることで、cactiというユーザでログインできないようにする。この辺は適当に手を抜いてrootでやったりすると怖いので忘れずに。次にcactiユーザでデータの読み書きするためにパーミションを変える。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;chown -R cacti:apache /var/www/localhost/htdocs/cacti
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;全部変えちゃったけどrraとlogディレクトリだけでいいかも。未検証。&lt;/p&gt;

&lt;h4&gt;cronの設定&lt;/h4&gt;

&lt;p&gt;適当なタイミングでスクリプトをブン回す。とりあえず5分間隔に設定。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;vi /etc/crontab
 */5 * * * * cacti   /usr/bin/php /var/www/localhost/htdocs/cacti/cmd.php &amp;gt; /dev/null 2&amp;gt;&amp;amp;1
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;cactiの設定&lt;/h4&gt;

&lt;p&gt;ブラウザから &lt;a href=&#34;http://hostname/cacti/&#34;&gt;http://hostname/cacti/&lt;/a&gt; にアクセス。デフォルトのユーザとパスワードはadmin/admin。ウィザードが始まるがNext押していけばいい。adminのパスワードは適当なものに変更する。&lt;/p&gt;

&lt;p&gt;色々設定するところがあるが、一番下にある参考URLらへんを参照。&lt;/p&gt;

&lt;p&gt;ここでrrdtoolからACCESS DENIEDと言われてグラフが上手く表示されなかった。よくわからんがcactiでadminじゃなくてcactiというユーザを作り、User Management→cacti→Graph PermissionsでDenyをAllowにお変更してSave。Graph Managementからなんかグラフを選んで、右上の*Turn On Graph Debug Mode.をクリックするとログが見えるようになるので押してみる。今度は&amp;rsquo;rra/localhost_load_1min_5.rrd&amp;rsquo;: No such file or directoryとか怒られる。&lt;/p&gt;

&lt;p&gt;見てみると確かにrraの下が空っぽなのでダメらしい。/var/www/localhost/htdocs/cacti/cmd.phpを実行してもエラーらしきものは出ておらず。しばらくココで嵌ったが、/var/www/localhost/htdocs/cacti/poller.phpを実行すればOKだった。1回目は前のデータがないので怒られるが、もう1度やると問題なく実行された。そのあとcactiからはちゃんと見えるようになった。&lt;/p&gt;

&lt;h4&gt;参考URL&lt;/h4&gt;

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&#34;http://www.boreas.dti.ne.jp/~mishiro/&#34; target=&#34;_blank&#34;&gt;Net-SNMPの設定方法&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;http://net-snmp.sourceforge.net/&#34; target=&#34;_blank&#34;&gt;net-snmp&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;http://www.photonway.net/AboutRrdtool.html&#34; target=&#34;_blank&#34;&gt;About Rrdtool&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;http://www.boreas.dti.ne.jp/~mishiro/rrdtool/&#34; target=&#34;_blank&#34;&gt;RRDtoolのすすめ&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;http://cacti.net/&#34; target=&#34;_blank&#34;&gt;cacti&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;http://cacti.loaded.jp/&#34; target=&#34;_blank&#34;&gt;グラフツールcactiとは?&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;http://www.stackasterisk.jp/tech/systemManagement/snmp01_01.jsp&#34; target=&#34;_blank&#34;&gt;【連載 】SNMPによるネットワークシステムの監視&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;http://www.aconus.com/~oyaji/suse9.3/cacti_linux1.htm&#34; target=&#34;_blank&#34;&gt;RRDTool+Cactiによるサーバ監視(Linux編)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>[memo] GentooにPlaggerをインストール</title>
      <link>http://nobu666.com/2006/11/11/439.html</link>
      <pubDate>Sat, 11 Nov 2006 01:29:02 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/11/11/439.html</guid>
      <description>&lt;p&gt;Gentooにはg-cpanという素晴らしいものがあるのだが、そこはあえて使わずにいく。というかなんか知らないけど上手くいかなかったので、仕方なく手動で入れたとも言う。とりあえず自宅サーバと言うことで、サックリrootになって入れることにする。そのほうが簡単。以前レンタルサーバで悩んだのがウソのようだ。ちゃんとログを取ってないので曖昧な記憶でメモ。&lt;/p&gt;

&lt;h4&gt;準備&lt;/h4&gt;

&lt;p&gt;別段何もない。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;perl -MCPAN -e shell
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;基本全部デフォルトのままENTER押してりゃよし。Gentooの場合、cpanでガンガン入れる前にまず&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;emerge expat
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これをやっておく。次にCPANのConfigを弄る。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-perl&#34;&gt;vi /usr/lib/perl5/5.8.8/CPAN/Config.pm
 $CPAN::Config = {
  &#39;build_cache&#39; =&amp;gt; q[100],
  &#39;build_dir&#39; =&amp;gt; q[/root/.cpan/build],
  &#39;bzip2&#39; =&amp;gt; q[/bin/bzip2],
  &#39;cache_metadata&#39; =&amp;gt; q[1],
  &#39;check_sigs&#39; =&amp;gt; q[0],
  &#39;colorize_output&#39; =&amp;gt; q[0],
  &#39;commandnumber_in_prompt&#39; =&amp;gt; q[1],
  &#39;cpan_home&#39; =&amp;gt; q[/root/.cpan],
  &#39;curl&#39; =&amp;gt; q[/usr/bin/curl],
  &#39;ftp&#39; =&amp;gt; q[/usr/bin/ftp],
  &#39;ftp_passive&#39; =&amp;gt; q[1],
  &#39;ftp_proxy&#39; =&amp;gt; q[],
  &#39;getcwd&#39; =&amp;gt; q[cwd],
  &#39;gpg&#39; =&amp;gt; q[],
  &#39;gzip&#39; =&amp;gt; q[/bin/gzip],
  &#39;histfile&#39; =&amp;gt; q[/root/.cpan/histfile],
  &#39;histsize&#39; =&amp;gt; q[100],
  &#39;http_proxy&#39; =&amp;gt; q[],
  &#39;inactivity_timeout&#39; =&amp;gt; q[0],
  &#39;index_expire&#39; =&amp;gt; q[1],
  &#39;inhibit_startup_message&#39; =&amp;gt; q[0],
  &#39;keep_source_where&#39; =&amp;gt; q[/root/.cpan/sources],
  &#39;lynx&#39; =&amp;gt; q[],
  &#39;make&#39; =&amp;gt; q[/usr/bin/make],
  &#39;make_arg&#39; =&amp;gt; q[],
  &#39;make_install_arg&#39; =&amp;gt; q[],
  &#39;make_install_make_command&#39; =&amp;gt; q[/usr/bin/make],
  &#39;makepl_arg&#39; =&amp;gt; q[],
  &#39;mbuild_arg&#39; =&amp;gt; q[],
  &#39;mbuild_install_arg&#39; =&amp;gt; q[],
  &#39;mbuild_install_build_command&#39; =&amp;gt; q[./Build],
  &#39;mbuildpl_arg&#39; =&amp;gt; q[],
  &#39;ncftp&#39; =&amp;gt; q[],
  &#39;ncftpget&#39; =&amp;gt; q[],
  &#39;no_proxy&#39; =&amp;gt; q[],
  &#39;pager&#39; =&amp;gt; q[lv -Ou8 -c],
  &#39;prefer_installer&#39; =&amp;gt; q[EUMM],
  &#39;prerequisites_policy&#39; =&amp;gt; q[ask],
  &#39;scan_cache&#39; =&amp;gt; q[atstart],
  &#39;shell&#39; =&amp;gt; q[/bin/zsh],
  &#39;show_upload_date&#39; =&amp;gt; q[1],
  &#39;tar&#39; =&amp;gt; q[/usr/bin/tar],
  &#39;term_is_latin&#39; =&amp;gt; q[1],
  &#39;term_ornaments&#39; =&amp;gt; q[1],
  &#39;test_report&#39; =&amp;gt; q[0],
  &#39;unzip&#39; =&amp;gt; q[/usr/bin/unzip],
  &#39;urllist&#39; =&amp;gt; [q[ftp://ftp.kddilabs.jp/CPAN/]],
  &#39;wget&#39; =&amp;gt; q[/usr/bin/wget],
 };
 1;
 __END__

cpan -i Bundle::CPAN
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h4&gt;CPANモジュールのインストール&lt;/h4&gt;
&lt;a href=&#34;http://subtech.g.hatena.ne.jp/otsune/20060816/PlaggerCPAN&#34; target=&#34;_blank&#34;&gt;Bundle::CPANとPlaggerに依存するモジュール（メモ）&lt;/a&gt;に従って進める。書いてあるとおり、TemplateとEncode::Detectはまともには入らないっぽいので諦めてforce installで。別段不都合はないので。&lt;/p&gt;

&lt;p&gt;なんかRDF::Coreが上手く入らなくて困った記憶がある。emerge expatしてないせいだった、という記憶もあるが…ちょっと覚えてない。でもコマンドの履歴に以下のものが残っていた。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;wget http://ftp.yz.yamagata-u.ac.jp/pub/lang/cpan/modules/by-module/RDF/DPOKORNY/RDF-Core-0.50.tar.gz
tar -zxvf RDF-Core-0.50.tar.gz
cd RDF-Core-0.50
perl Makefile.PL
make
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;手動で入れたっぽい。若年アルツで覚えてない。まぁとりあえず頑張って入れて、cpanシェルでtest Plaggerが通るまで頑張る。通ったらinstall Plagger。&lt;/p&gt;

&lt;p&gt;&lt;h4&gt;リポジトリから最新取得&lt;/h4&gt;
subversionを使ってリポジトリから最新版を持ってきてmakeする。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;svn co http://svn.bulknews.net/repos/plagger/trunk/plagger
cd plagger
perl Makefile.PL
make
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ここまで行ったら出来たも同然。Plagger3大罠の1つである、assetsのコピーを忘れないうちにやっておく。svnで最新版を入れたディレクトリのassets以下に、　.cpan/build/Plagger-x.x.xx/assets/plugins/Publish-Gmail/gmail_notify.tt をコピっておく。yamlのglobalでassets_pathを指定するのも忘れずに。ちなみにyamlのサンプルは .cpan/build/Plagger-x.x.xx/examples 以下に入っているので、適当な場所にコピって編集すべし。&lt;/p&gt;

&lt;p&gt;まぁ何が言いたいかって言うとレン鯖だと非常に苦労したインストールも、自宅鯖なら超簡単だぜってことです。gmailのメール送信量制限も、自宅鯖なら無関係。cacheもレン鯖だと、HDDが1Gくらいしかないので気にしなきゃいけないけど自宅鯖にはほぼ無関係。足りなくなったら増やせばイイだけだし。Plagger自体それなりに負荷があるので、レン鯖の場合は30分単位くらいで回さないと怒られそうなのだが、それを気にしなくていいのが一番でかい。もう5分とかで回してる。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] rep2をSSL&#43;Basic認証で使う</title>
      <link>http://nobu666.com/2006/11/04/429.html</link>
      <pubDate>Sat, 04 Nov 2006 02:24:07 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/11/04/429.html</guid>
      <description>&lt;p&gt;通勤時の電車の中では本を読んでいるか、暇つぶしに2ch見てるわけだが。どうせ携帯で見るなら自宅サーバのリソースも余ってることだし有効活用したい。そんなわけで&lt;a href=&#34;http://akid.s17.xrea.com/&#34; target=&#34;_blank&#34;&gt;rep2&lt;/a&gt;を使うことにした。&lt;/p&gt;

&lt;p&gt;&lt;h4&gt;インストール&lt;/h4&gt;
とりあえずダウンロードして、/var/www/localhost/rep2とかに置く。apacheは当然SSL有効でコンパイルしておくこと。phpはやたらに使用可能なフラグが多いのでメモっておく。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;emerge -pv php

These are the packages that would be merged, in order:

Calculating dependencies... done!
[ebuild   R   ] dev-lang/php-5.1.6-r6  USE=&amp;quot;apache2 bzip2 cjk cli crypt curl curlwrappers gd iconv mysql ncurses nls pcre readline sasl session spell ssl threads unicode xml xmlrpc zlib (-adabas) -apache -bcmath -berkdb (-birdstep) -calendar -cdb -cgi -concurrentmodphp -ctype -db2 -dbase (-dbmaker) -debug -discard-path -doc (-empress) (-empress-bcs) (-esoob) -exif -fastbuild (-fdftk) (-filepro) (-firebird) -flatfile -force-cgi-redirect (-frontbase) -ftp -gd-external -gdbm -gmp -hardenedphp -hash -hyperwave-api -imap (-informix) -inifile -interbase -iodbc -ipv6 -java-external -kerberos -ldap -libedit -mcve -memlimit -mhash -ming -msql -mssql -mysqli -oci8 (-oci8-instant-client) -odbc -pcntl -pdo -pdo-external -pic -posix -postgres -qdbm -recode -reflection -sapdb -sharedext -sharedmem -simplexml -snmp -soap -sockets (-solid) -spl -sqlite (-sybase) (-sybase-ct) -sysvipc -tidy -tokenizer -truetype -vm-goto -vm-switch -wddx -xmlreader -xmlwriter -xpm -xsl -yaz -zip&amp;quot; 0 kB
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;rep2はPEARモジュールのいくつかが必須なので、PEARもと必須モジュールを入れる。eixで見つからなかったものはpearコマンドで入れ、見つかったものはemergeで入れた。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;emerge PEAR-PEAR
pear install Net_UserAgent_Mobile-beta
pear install PHP_Compat
emerge PEAR-HTTP_Request
emerge PEAR-Pager
emerge PEAR-File
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h4&gt;phpの設定&lt;/h4&gt;
/etc/php/apache2-php5/php.iniの次のコメントアウトを外す。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;[mbstring]
mbstring.internal_encoding = EUC-JP
mbstring.http_input = auto
mbstring.http_output = EUC-JP
mbstring.detect_order = auto
mbstring.substitute_character = none;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h4&gt;apacheの設定&lt;/h4&gt;
SSLを使うため、認証局と証明書が必要。&lt;a href=&#34;http://nobu666.com/2006/10/29/000423.html&#34;&gt;[修正版][memo] postfix + dovecotでSMTP AUTH &amp;amp; IMAPなメールサーバを立ち上げる&lt;/a&gt;で作成したものがあるのでそれを流用する。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cp -p /etc/ssl/postfix/server.crt /etc/apache2/ssl/ 
cp -p /etc/ssl/postfix/server.key /etc/apache2/ssl/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;次にBasic認証に使う.htaccessをフォルダで上書きできるようにしておくため、/etc/apache2/modules.d/41_mod_ssl.default-vhost.confと/etc/apache2/vhosts.d/00_default_vhost.confの&lt;directory &#34;/var/www/localhost/htdocs&#34;&gt;部分を以下のように設定する。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-xml&#34;&gt;&amp;lt;directory &amp;quot;/var/www/localhost/htdocs&amp;quot;&amp;gt;
    Options FollowSymLinks
    AllowOverride AuthConfig
&amp;lt;/directory&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h4&gt;.htaccessの設定&lt;/h4&gt;
/var/www/localhost/htdocs/rep2に.htaccessを作成(サイト全体に認証をかけたいならhtdocsの下でも可)。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;vi /var/www/localhost/htdocs/rep2/.htaccess
 AuthName &amp;quot;User Authentication Required&amp;quot;
 AuthType Basic
 Require valid-user
 AuthUserFile /etc/apache2/.htpasswd
htpasswd2 -c /etc/apache2/.htpasswd ユーザ名
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h4&gt;apacheの起動パラメータ&lt;/h4&gt;
gentooのapacheは、有効にしたいモジュールを明示しないといけないので、/etc/conf.d/apache2を修正。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;vi /etc/conf.d/apache2
 APACHE2_OPTS=&amp;quot;-D SSL -D PHP5 -D DEFAULT_VHOST -D SSL_DEFAULT_VHOST&amp;quot;
/etc/init.d/apache2 restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これで　https://ホスト名:443/rep2/　に行けばユーザ名とパスワードが聞かれるはず。念のため携帯からもアクセスして問題なく認証できれば万事OK。ただ携帯でパスワードを入力するのは面倒なので、どうにか携帯の固有IDでパスできないか調べ中。auだとHTTP_X_UP_SUBNOで取れるみたいなんだが…&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] GentooでUPS(APC ES 500)を使う</title>
      <link>http://nobu666.com/2006/10/30/424.html</link>
      <pubDate>Mon, 30 Oct 2006 01:29:11 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/30/424.html</guid>
      <description>&lt;p&gt;&lt;a href=&#34;http://www.amazon.co.jp/exec/obidos/ASIN/B0000AG7HB/realbeat-22/ref=nosim/&#34; name=&#34;amazletlink&#34; target=&#34;_blank&#34;&gt;&lt;img src=&#34;http://images-jp.amazon.com/images/P/B0000AG7HB.09.MZZZZZZZ.jpg&#34; alt=&#34;APC ES 500&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Amazonで\7,000ちょっとという値段だったので、購入したのが届いた。流石に24時間稼働だとUPSがないと怖い。今年の雷で瞬断も多くあったので。付属のPowerCuteはWindowsとMacOS Xと商用Linuxにしか対応していないので自力でどうにかする方法をメモ。&lt;/p&gt;

&lt;h4&gt;準備と接続、認識確認&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;emerge apcupsd
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;なにはなくともコレがないと始まらない。とりあえずインストールしたら一旦シャットダウンしてコンセントをUPSにつなぎ変え、付属のUSB通信ケーブルでUPSとサーバを接続して再起動。再起動したらdmesgを見てサーバがES500を認識しているか確認。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;usbcore: registered new driver hiddev
hiddev0: USB HID v1.10 Device [APC APC ES 500 FW:803.p6.A USB FW:p6] on usb-0000:00:10.2-2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記のようなメッセージがあれば問題ない。が、&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;es500 hid device not claimed
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;とか出てたら認識していない。俺の場合は思い切り認識していなかった。要するにまたカーネル再構築。だがもう手慣れたモンなのでサクサクと再構築する。こういうときはマシンパワーがあると非常に楽だ。お約束の以下の呪文を唱える。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cd /usr/src/linux
make menuconfig
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;そして今の設定をLOADして、以下のところにチェックを付けて保存。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-xml&#34;&gt;Device Drivers ---&amp;gt;
    USB Support ---&amp;gt;
        /dev/hiddev raw HID device support
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;またお約束の呪文。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;make &amp;amp;&amp;amp; make modules_install
cp arch/x86_64/boot/bzImage /boot/なんか適当な名前
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;そしたら/boot/grub/grub.confを編集して再起動すればいい。今度はちゃんと認識されているはず。念のためapcaccess statusとやってエラーが出ないことを確認する。&lt;/p&gt;

&lt;h4&gt;設定と動作確認&lt;/h4&gt;

&lt;p&gt;次はapcupsdの設定を行う。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cat /etc/apcupsd/apcupsd.conf
UPSCABLE usb
UPSTYPE usb
DEVICE
LOCKFILE /var/lock
ONBATTERYDELAY 6
BATTERYLEVEL 5
MINUTES 3
TIMEOUT 10
ANNOY 300
ANNOYDELAY 60
NOLOGON disable
KILLDELAY 0
NETSERVER on
NISIP 0.0.0.0
NISPORT 3551
EVENTSFILE /var/log/apcupsd.events
EVENTSFILEMAX 10
UPSCLASS standalone
UPSMODE disable
STATTIME 0
STATFILE /var/log/apcupsd.status
LOGSTATS off
DATATIME 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;殆どデフォルト。TIMEOUTに関しては動作確認のため10にした。これは10だと電源断から10秒でシャットダウンするということ。実際にapcupsdを動かして試してみる。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;/etc/init.d/apcupsd start
rc-update add apcupsd default
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;思い切ってUPSのコンセントをぶっこ抜いてみる。ピーピーピーと警告音が鳴り、10秒後にシャットダウン処理が走れば成功。忘れないようにTIMEOUTは0にしておくこと。ここを0にしておくとUPS側のバッテリーで頑張ってくれるようになる。どのくらい頑張るかはBATTERYLEVELとMINUTESで決まる。BATTERYLEVELはバッテリ残量が残り何%になったらシャットダウンするかで、MINUTESは残り時間何分でシャットダウンするか。どちらかの条件を満たすとシャットダウンされる。お好みで変える。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[修正版][memo] postfix &#43; dovecotでSMTP AUTH &amp; IMAPなメールサーバを立ち上げる</title>
      <link>http://nobu666.com/2006/10/29/423.html</link>
      <pubDate>Sun, 29 Oct 2006 17:42:48 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/29/423.html</guid>
      <description>&lt;p&gt;&lt;a href=&#34;http://nobu666.com/2006/10/25/000420.html&#34;&gt;[memo] postfix + dovecotでSMTP AUTH &amp;amp; IMAPなメールサーバを立ち上げる&lt;/a&gt;があまり正しくないので修正版。&lt;/p&gt;

&lt;h4&gt;ssmtpの削除&lt;/h4&gt;
Gentooではいきなりpostfixを入れようとしても、デフォルトでssmtpが入っていてblockされるのでssmtpを消すのが先決。

```bash
emerge -C ssmtp
```

&lt;h4&gt;postfixとdovecotのインストール&lt;/h4&gt;
Gentooの基本だけど、emergeするときはemerge -pvでどんなフラグが有効になるか必ず確認。必要ないならpackage.useで外す。あとsaslが必要なのでこれは付けておく。あとなんでかわからないけどpostfixにsaslを付けるとついてくるcyrus-saslで、gdbmやcryptをUSEするとコンパイルに失敗したので外した。

```bash
emerge -pv postfix dovecot
echo &#34;mmail-mta/postfix -mysql sasl&#34; &gt;&gt; /etc/portage/package.use
echo &#34;dev-libs/cyrus-sasl -mysql -java -gdbm -crypt&#34; &gt;&gt; /etc/portage/package.use
emerge postfix dovecot
```

&lt;h4&gt;オレオレ認証局の作成&lt;/h4&gt;
Gentooでの方法なので他のディストリではパスが違うようなので注意。

```bash
mkdir /etc/certs
chmod 700 /etc/certs 
cd /etc/certs
cp /etc/ssl/misc/CA.pl .
perl ./CA.pl -newca
CA certificate filename (or enter to create)
(ENTER)
Making CA certificate ...
Generating a 1024 bit RSA private key
..................................++++++
.......................++++++
writing new private key to &#39;./demoCA/private/cakey.pem&#39;
Enter PEM pass phrase:(パスフレーズを入力)
Verifying - Enter PEM pass phrase:(同じパスフレーズをもう一度入力)
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:JP
State or Province Name (full name) [Some-State]:Kanagawa
Locality Name (eg, city) []:Yokohama
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Private
Organizational Unit Name (eg, section) []:Private
Common Name (eg, YOUR name) []:nobu666.fam.cx
Email Address []:root@nobu666.fam.cx

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:(ENTER)
An optional company name []:(ENTER)
Using configuration from /etc/ssl/openssl.cnf
Enter pass phrase for ./demoCA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
 (略)
Certificate is to be certified until Oct 28 06:15:58 2009 GMT (1095 days)

Write out database with 1 new entries
Data Base Updated
```

&lt;h4&gt;クライアント用CA証明書とサーバ用CA証明書を作成&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cd /etc/certs/demoCA
openssl x509 -inform pem -in cacert.pem -outform der -out cacert.der 
openssl x509 -in ./cacert.pem -out ./cacert.crt
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;デジタル証明書のリクエストファイルを作成&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cd /etc/certs
perl ./CA.pl -newreq-nodes
Generating a 1024 bit RSA private key
...++++++
...............................................................................................................++++++
writing new private key to &#39;newkey.pem&#39;
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:JP
State or Province Name (full name) [Some-State]:Kanagawa
Locality Name (eg, city) []:Yokohama
Organization Name (eg, company) [Internet Widgits Pty Ltd]:nobu666.fam.cx
Organizational Unit Name (eg, section) []:Admin
Common Name (eg, YOUR name) []:nobu666.fam.cx
Email Address []:root@nobu666.fam.cx

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:(ENTER)
An optional company name []:(ENTER)
Request is in newreq.pem, private key is in newkey.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;リクエストファイルからX.509サーバ証明書の作成と署名&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;perl ./CA.pl -sign
Using configuration from /etc/ssl/openssl.cnf
Enter pass phrase for ./demoCA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            ce:db:05:2a:6a:dc:75:17
        Validity
            Not Before: Oct 29 06:51:11 2006 GMT
            Not After : Oct 29 06:51:11 2007 GMT
        Subject:
            countryName               = JP
            stateOrProvinceName       = Kanagawa
            localityName              = Yokohama
            organizationName          = nobu666.fam.cx
            organizationalUnitName    = Admin
            commonName                = nobu666.fam.cx
            emailAddress              = root@nobu666.fam.cx
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            Netscape Comment:
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier:
                7B:0E:46:62:02:FB:B6:A6:05:DC:DE:75:2E:2D:5A:29:5D:31:79:F8
            X509v3 Authority Key Identifier:
                keyid:A7:51:EC:0A:BD:B6:70:68:A5:01:ED:8E:76:1F:FE:0C:4D:B2:A0:19

Certificate is to be certified until Oct 29 06:51:11 2007 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
Signed certificate is in newcert.pem

openssl x509 -in newcert.pem -out server.crt
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;postfix用にシンボリックリンクを張る&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;ln -sf /etc/certs/server.crt /etc/ssl/postfix/server.crt
ln -sf /etc/certs/newkey.pem /etc/ssl/postfix/server.key
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;postfixの設定&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;vi /etc/postfix/main.cf

queue_directory = /var/spool/postfix
command_directory = /usr/sbin
daemon_directory = /usr/lib/postfix
mail_owner = postfix
myhostname = nobu666.fam.cx
mydomain = nobu666.fam.cx
myorigin = $mydomain
inet_interfaces = all
mydestination = $myhostname, localhost.$mydomain, $mydomain, mail.$mydomain, localhost
unknown_local_recipient_reject_code = 550
mynetworks_style = subnet
mynetworks = 192.168.0.0/24, 127.0.0.0/8
relay_domains = $mydestination
alias_maps = hash:/etc/mail/aliases
alias_database = hash:/etc/mail/aliases
home_mailbox = .Maildir/

header_checks = regexp:/etc/postfix/header_checks
smtpd_banner = $myhostname ESMTP $mail_name ($mail_version)
mydestination = $myhostname, localhost.$mydomain, $myhostname.$mydomain, mail.$mydomain, localhost
debug_peer_level = 2
debugger_command =
         PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin
         xxgdb $daemon_directory/$process_name $process_id &amp;amp;amp; sleep 5
sendmail_path = /usr/sbin/sendmail
mailq_path = /usr/bin/mailq
setgid_group = postdrop
html_directory = /usr/share/doc/postfix-2.2.10/html
manpage_directory = /usr/share/man
sample_directory = /etc/postfix
readme_directory = /usr/share/doc/postfix-2.2.10/readme
smtpd_use_tls = yes
smtpd_tls_loglevel = 1
smtpd_tls_cert_file = /etc/ssl/postfix/server.crt
smtpd_tls_key_file = /etc/ssl/postfix/server.key
smtpd_tls_session_cache_database = btree:/etc/postfix/smtpd_scache
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtp_sasl_security_options = noanonymous
allow_mail_to_commands = alias,forward,include
message_size_limit = 1024000
smtpd_client_restrictions =
            permit_mynetworks,
            permit_sasl_authenticated,
            permit_auth_destination,
            reject

vi /etc/postfix/master.cf

submission inet n      -       n       -       -       smtpd
        -o smtpd_etrn_restrictions=reject
        -o smtpd_client_restrictions=permit_sasl_authenticated,reject

&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;saslの設定&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;vi /etc/sasl2/smtpd.conf

pwcheck_method: saslauthd

mkdir /var/state/saslauthd
chmod 700 /var/state/saslauthd
chown postfix /var/state/saslauthd
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;dovecotの設定&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;vi /etc/dovecot.conf

protocols = pop3 imap
ssl_disable = no
ssl_cert_file = /etc/ssl/postfix/server.crt
ssl_key_file = /etc/ssl/postfix/server.key
default_mail_env = maildir:%h/.Maildir

chmod 755 /var/run/dovecot
chmod 750 /var/run/dovecot/login
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;あとはデフォルトのまま。&lt;/p&gt;

&lt;p&gt;&lt;h4&gt;クライアントの設定&lt;/h4&gt;
まずはオレオレ認証局の証明書をクライアントに入れる必要がある（やらなくてもいいが警告が出るので…）。別にどうやってクライアントに渡してもOK。FTPとかSCPとかで適当に。メーラによって操作が違うがThunderbirdの場合は、ツール→オプション→プライバシー→セキュリティ→証明書を表示→認証局証明書→インポートと進んで、cacert.derを選択すればOK。あとはIMAPでアカウントを作って、受信は143番ポートでTLSを使うようにし、送信は587番ポートで同じくTLSを使うように設定する。送信テストするとユーザ名とパスワードが聞かれるので「パスワード無しで送信できないこと」「間違ったパスワードを入れて送信できないこと」「正しいパスワードを入れて送信できること」の3つを確認して終了。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] iptablesが使えないのでkernel再構築 &amp; sshdへのアタックをどうにかする</title>
      <link>http://nobu666.com/2006/10/28/421.html</link>
      <pubDate>Sat, 28 Oct 2006 04:12:00 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/28/421.html</guid>
      <description>&lt;p&gt;なんつーかね、某krからのsshdへのBrute force attacksが酷すぎる。auth.logを埋め尽くすほどのアタックを食らったので対策することに。だが普通にインストールするとiptablesが動いてくれないので、カーネル再構築に挑戦する。&lt;/p&gt;

&lt;p&gt;別に今回はkernelのバージョンを上げたいわけではなく、単純にカーネルのオプションを変えたいだけなので、emerge gentoo-sourcesはやらない。以下、rootになって作業を行う。あとmenuconfigはscreenの中でやると表示が乱れて酷いことになるので、screenをデタッチするなり抜けるなりしてからやったほうがいい。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cd /usr/src/linux
make menuconfig
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Confgurationが立ち上がったら、まずLoad an Alternate Configuration Fileを選ぶ。&amp;rdquo;.config&amp;rdquo;が入力されているはずなので、そのままOKすると現在の設定が読み込まれる。そしたら&lt;/p&gt;

&lt;pre&gt;
Networking  ---&gt;
  Networking options  ---&gt; 
    Network packet filtering (replaces ipchains)  ---&gt;
      Core Netfilter Configuration  ---&gt;
         Netfilter Xtables support (required for ip_tables)
&lt;/pre&gt;

&lt;p&gt;を選択。その下に色々あるが、よくわからないならMにしといてあとでModuleとして読めるようにしておくと吉。必要なのに何もチェックしないでおくと、再度カーネル再構築が必要になって面倒なので。チェックしたら1つ戻ってIP: Netfilter Configurationの中に入る。とりあえず必須なのはIP tables support (required for filtering/masq/NAT)と、IP range match support、Packet filtering、REJECT target support、address type match support、Full NAT、MASQUERADE target supportとかそのへん。終わったらTOPまで戻って、念のため設定ファイルをなんか名前付けて保存しておいたほうがいい。&lt;/p&gt;

&lt;p&gt;あとはその辺のサイトに書いてあるとおり、お約束でOK。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;make &amp;amp;&amp;amp; make modules_install
cp arch/x86_64/boot/bzImage /boot/なんか適当な名前
vi /boot/grub/grub.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;grub.confの設定では、元々書いてあるものを絶対に消さないこと。消しちゃうと万が一再構築したカーネルで起動できなかったときに面倒。&lt;/p&gt;

&lt;p&gt;[sourecode lang=&amp;ldquo;text&amp;rdquo;]
title=Gentoo Linux 2.6.17-r8
root (hd0,0)
kernel /さっきbootの下にcpしたファイル名 root=/dev/sda3 vga=ask&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;
とかで問題なし。vga=askの部分はまぁお好みで。/usr/src/linux/Documentation/fb/vesafb.txtとかを参考に。基本的にはこれでrebootして、上のtitleでつけた名前を選択して起動してやればとりあえずOKなはずだ。失敗したら残しておいた方で起動して修正すべし。消してしまったお馬鹿さんはinstall cdから起動して/dev/sda1とかをmountして編集すれば戻せる。あとvgaとかvideoのオプションは、間違うと画面に何も表示されなくなるので注意。まぁリモート操作がメインならそれでもいいのかも知れないけど、何かあったときにアレなんで…心配ならaskにしておいて選択するのが間違いない。

そこまで出来たらDebian GNU/Linux 3.1(sarge)運用ノートの&amp;lt;a href=&amp;quot;http://www.musicae.ath.cx/diary/?200506c&amp;amp;to=200506272#200506272&amp;quot; target=&amp;quot;_blank&amp;quot;&amp;gt;SSH Brute force attacks&amp;lt;/a&amp;gt;の通りに設定してから

```bash
/etc/init.d/iptables save
/etc/init.d/iptables start
rc-update add iptables default
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以上で終了。エラーが出てiptablesが動かない場合は必要なモジュールが選択漏れでコンパイルされていないとか、Mを選択したのにmodprobeなりinsmodしてない。てか俺もこの手順にたどり着くまで5回くらい再構築してこんな時間に…もう寝る!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] postfix &#43; dovecotでSMTP AUTH &amp; IMAPなメールサーバを立ち上げる</title>
      <link>http://nobu666.com/2006/10/25/420.html</link>
      <pubDate>Wed, 25 Oct 2006 23:59:30 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/25/420.html</guid>
      <description>&lt;p&gt;2006/10/29追記: イマイチ不正確なので&lt;a href=&#34;http://nobu666.com/2006/10/29/000423.html&#34;&gt;[修正版][memo] postfix + dovecotでSMTP AUTH &amp;amp; IMAPなメールサーバを立ち上げる&lt;/a&gt;で書き直しました。そちらをみてください。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] サーバのCPU動作周波数を動的に変える</title>
      <link>http://nobu666.com/2006/10/24/418.html</link>
      <pubDate>Tue, 24 Oct 2006 15:50:23 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/24/418.html</guid>
      <description>&lt;p&gt;&lt;a href=&#34;http://nobu666.com/2006/10/23/000415.html&#34;&gt;[memo] サーバのCPU動作周波数を下げる&lt;/a&gt;の続き。&lt;/p&gt;

&lt;p&gt;やってみないとわからんので、cpufreq_ondemandを試してみる。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;modprobe cpufreq_ondemand
echo ondemand &amp;gt; /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

cd /sys/devices/system/cpu/cpu0/cpufreq/ondemand/
ls
ignore_nice_load  sampling_down_factor  sampling_rate  sampling_rate_max  sampling_rate_min  up_threshold

cat ignore_nice_load
0

cat sampling_down_factor
1

cat sampling_rate
1040000

cat sampling_rate_max
520000000

cat sampling_rate_min
520000

cat up_threshold
80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;詳細は&lt;a href=&#34;http://mowamowa.p.utmc.or.jp/~amedama/cgi-bin/wiki/wiki.cgi?page=Kernel+%A5%E1%A5%E2+ondemand&#34; target=&#34;_blank&#34;&gt;Kernel メモ ondemand&lt;/a&gt;参照。とりあえずignore_nice_loadは1に設定しておいた。急がないけど負荷になりそうな作業なんかはniceすること。&lt;/p&gt;

&lt;p&gt;実際にemerge &amp;ndash;syncとかして/proc/cpuinfoを見てたら、普段1GHzで動作しているのが2GHz→1.8GHzとなって1GHzに戻った。上手く動いているっぽい。試しにnice revdep-rebuildとかすると1GHzから変わらないことも確認。とりあえずこのまま運用してみる。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] TortoiseSVNからsvn&#43;sshを使う</title>
      <link>http://nobu666.com/2006/10/24/417.html</link>
      <pubDate>Tue, 24 Oct 2006 15:36:27 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/24/417.html</guid>
      <description>&lt;p&gt;普通にsshで繋がるようになったらsvn+sshを使いたくなる。サーバー側はemerge subversionするぐらいで設定は特にない。svnadmin create /var/svn/hoge とか svn import ~/moge file:///var/svn/hogeとかしておくだけ。svnserveを立ち上げる必要はない。svn+sshで接続するときは、sshで認証した後svnserve -tを勝手にしてくれ、接続を切るとsvnserveプロセスもなくなってくれる。よってルータで3690番のポートを開けておくとかいう作業は必要ない。22番だけ開いていればいい。&lt;/p&gt;

&lt;p&gt;クライアント側は、Poderosaで作った鍵(例えばファイル名をid_rsaとする)しかない場合はPuTTY用の鍵を作る。puttygenを起動して、秘密鍵を読み込んでパスフレーズを入力すれば変換される。変換された秘密鍵をid_rsa.ppkとして保存。とりあえずPuTTYを起動して接続-データで自動ログインのユーザ名と、接続-SSH-認証で認証のためのプライベートキーファイルでさっきの.ppkファイルを設定。接続してみてパスフレーズ入力してログイン出来ればOK。&lt;/p&gt;

&lt;p&gt;次にputty.exeと同じフォルダにあるpageant.exeを起動する。タスクトレイに常駐するので右クリックして鍵の追加を選んで、.ppkを選択する。パスフレーズを入力すれば作業終わり。以降、PuTTYでもTortoiseSVNでもパスフレーズは入力しないでもいい。ただ、これはWindowsにログインしなおすと消えてしまうので、ログイン毎に鍵の追加→パスフレーズの入力を行う必要がある。ランチャーに登録するかスタートアップに入れておく。&lt;/p&gt;

&lt;p&gt;後はTortoiseSVNの設定で、ネットワークにあるSSHクライアントにTortoisePlink.exeを設定。これでTortoiseSVNからリボジトリブラウザを開いて、URL欄に svn+ssh://ユーザ名@ホスト名/var/svn/hoge と入力してエラーが出なければ終了。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] USEフラグをいい感じに管理する</title>
      <link>http://nobu666.com/2006/10/24/416.html</link>
      <pubDate>Tue, 24 Oct 2006 02:40:03 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/24/416.html</guid>
      <description>&lt;p&gt;俺のようにしょっちゅうemergeしたい人はUSEフラグの管理が大変だ。知らないうちに勝手にgtk2フラグが有効になっててXがインストールされたりして大変ウザイ。そんなわけでGentoo使いの先輩に教えて貰ったeixとeuseを使ってみる。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo emerge eix
sudo eix-sync
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;euseはgentoolkitに入っている。eixはemerge &amp;ndash;searchと似たようなモンだがこっちのほうが速いし使いやすい。んで、本題のeuseだが、使い方自体は&amp;ndash;helpすりゃわかるんだが。フラグの説明見たり、どれが使われてるか見れたり、フラグを有効にしたり無効にしたりできる。つーか詳細はman euseで（ｗ euse使うとmake.confのUSEフラグの部分が整形されて見やすくなるのも嬉しい。まぁ説明見るだけなら /usr/portage/profiles/use.desc
 見ればいいんだが。&lt;/p&gt;

&lt;p&gt;同じくgentoolkitに含まれているequeryも激しく便利。こいつで&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;equery depends mysql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;とかやってやればmysqlフラグに依存しているパッケージを調べることが出来るし、dependsをdepgraphに変えてやると依存関係をツリーで見れる。超便利。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] サーバのCPU動作周波数を下げる</title>
      <link>http://nobu666.com/2006/10/23/415.html</link>
      <pubDate>Mon, 23 Oct 2006 23:59:04 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/23/415.html</guid>
      <description>&lt;p&gt;CPUに関する情報は/sys/devices/system/cpu/cpu0/cpufreq/で次のファイルをcatする。まぁファイル名のまんまだが。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;affected_cpus : 影響する他のCPU。俺の場合はデュアルコアなので当然0と1&lt;/li&gt;
&lt;li&gt;cpuinfo_cur_freq : 現在の動作周波数&lt;/li&gt;
&lt;li&gt;cpuinfo_max_freq : 最大周波数。AMD64X2 3800+の場合は2000000&lt;/li&gt;
&lt;li&gt;cpuinfo_min_freq : 最低周波数。AMD64X2 3800+の場合は1000000&lt;/li&gt;
&lt;li&gt;scaling_available_freqyencies : 設定可能な周波数。AMD64X2 3800+の場合は2000000/1800000/1000000しかない。intelだともっと多いらしい&lt;/li&gt;
&lt;li&gt;scaling_available_governors : 設定可能な動作モード。Gentooのデフォルトではperformanceのみ&lt;/li&gt;
&lt;li&gt;scaling_cur_freq : 現在の動作周波数&lt;/li&gt;
&lt;li&gt;scaling_driver : 周波数コントロールのための仕組みの名前&lt;/li&gt;
&lt;li&gt;scaling_governor : 動作モード。scaling_available_governorsのどれか&lt;/li&gt;
&lt;li&gt;scaling_max_freq : cpuinfo_max_freqと何が違うのかわからん&lt;/li&gt;
&lt;li&gt;scaling_min_freq : cpuinfo_min_freqと何が違うのかわからん&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;普段は高周波数で動いてくれなくていいというか、その方が電気代が安くなって地球に優しいためいい感じ。そんなわけで以下の手順を踏んで周波数を下げてみた。&lt;/p&gt;

&lt;p&gt;(今の周波数を確認)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(どんなdriverがあるか探す)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;find /lib/modules/2.6.17-gentoo-r7/ -name &#39;*.ko&#39;|grep cpu
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(明らかにそれっぽい奴を見つけたので読み込む)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo modprobe cpufreq_powersave
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(動作モードが増えたことを確認)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(動作モードを上で確認したやつに変更)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;su - ; echo &amp;quot;powersave&amp;quot; &amp;gt; /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 
exit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(周波数が下がったことを確認)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これだと確かに周波数は下がるが下がりっぱなしだ。Gentooだと最新を追っかけたい人はコンパイルをしょっちゅうするので、そういうときにいちいち戻すのが面倒だ。そこでcpufreq_ondeamndというdriverを使うと、なんかいい感じに自動化できそうな予感がする。が、もうちょっと調べて、しっかり設定しないと下がりっぱなしとか上がりっぱなしになりそうな予感がするのでとりあえずスルー。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>[memo] Gentooインストールメモ</title>
      <link>http://nobu666.com/2006/10/22/413.html</link>
      <pubDate>Sun, 22 Oct 2006 20:04:41 +0900</pubDate>
      
      <guid>http://nobu666.com/2006/10/22/413.html</guid>
      <description>&lt;p&gt;特に書くことないほどあっさり終了。&lt;a href=&#34;http://mirror.gentoo.gr.jp/releases/amd64/current/livecd/livecd-amd64-installer-2006.1.iso&#34;&gt;LiveCD&lt;/a&gt;を焼いてそいつでブートし、デスクトップ画面が出てきたら&amp;rdquo;Gentoo Linux installer&amp;rdquo;をダブルクリックして指示に従っていくだけ。つか&lt;a href=&#34;http://www9.ocn.ne.jp/~pcvolu/pcnet/gentopage122.htm&#34; target=&#34;_blank&#34;&gt;パソコンふぉあ障害者ず Gentoo Linux 2006.0(インストール-LiveCD-)&lt;/a&gt;を参考に。変えたところはIPアドレスとかその辺のネットワーク設定周りと、ステージを3からにしたのと、CFLAGで-O3にしたぐらい。インストールが終わったら上部のメニューからrebootしてCD抜いて終わり。&lt;/p&gt;

&lt;p&gt;pingして外に繋がることを確認したら&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;emerge --sync
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;してから、必要なものをガンガン入れるんだが、その前に&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;/etc/init.d/hdparm start
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;してDMAを有効にしておく。んでいい加減sshで繋いで作業したいので&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;nano -w /etc/ssh/sshd_config
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で適切にsshを設定。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;PermitRootLogin no
RSAAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;とかそんな感じに。&lt;/p&gt;

&lt;p&gt;クライアントで鍵セットを作って、USBメモリでサーバに公開鍵を置く。マウントするのは&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir /mnt/usbmemory
mount -t vfat /dev/sdb1 /mnt/usbmemory
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で、/mnt/usbmemoryが見えるようになる。後は公開鍵を置いてパーミッション変えればOK。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir ~/.ssh
cat /mnt/usbmemory/id_rsa &amp;gt;&amp;gt; ~/.ssh/authorized_keys
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;クライアントからsshで繋いでrootになって、ひたすら&lt;code&gt;emerge -av パッケージ名&lt;/code&gt;。入れたパッケージは以下の通り。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;管理系:gentoolkit/htop/traceroute/tcpdump&lt;/li&gt;
&lt;li&gt;デーモン系:apache2/proftpd/mysql/subversion/trac/samba&lt;/li&gt;
&lt;li&gt;ユーティリティ系:sudo/screen/ftp/zsh/w3m/svk/lv/nkf&lt;/li&gt;
&lt;li&gt;言語:python/ruby/jdk/groovy&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;keywordでmaskされてるとか怒られるやつは&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;ACCEPT_KEYWORDS=&amp;quot;~amd64&amp;quot; emerge -av パッケージ名
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で入る。色々入れたり消したりしてるうちに依存関係がおかしくなったりしたときは、revdep-rebuildする。特定のライブラリに依存するもの、とかの指定もできる。&lt;/p&gt;

&lt;p&gt;あとはapacheやらsambaやらの設定だな。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>