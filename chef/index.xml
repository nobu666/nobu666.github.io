<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Chef on Real Beat</title>
    <link>http://localhost:1313/categories/chef.html</link>
    <description>Recent content in Chef on Real Beat</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <copyright>&amp;copy; nobu666.com</copyright>
    <lastBuildDate>Wed, 13 Mar 2013 15:36:50 +0900</lastBuildDate>
    <atom:link href="http://localhost:1313/categories/chef.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Chef11のchef-serverをHA構成にする</title>
      <link>http://localhost:1313/2013/03/13/985.html</link>
      <pubDate>Wed, 13 Mar 2013 15:36:50 +0900</pubDate>
      
      <guid>http://localhost:1313/2013/03/13/985.html</guid>
      <description>&lt;h1&gt;Chef11のchef-serverをHA構成にする&lt;/h1&gt;

&lt;h2&gt;はじめに&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://wiki.opscode.com/display/chef/Chef+11+Server+Preview&#34; title=&#34;Chef11&#34;&gt;Chef11&lt;/a&gt;はいままでのChefとはserverの構成がガラリと変わり、APIがRubyからErlangに、バックエンドのCouchDBがPostgreSQLになりました。その他はフロントエンドには&lt;a href=&#34;http://nginx.org/&#34; title=&#34;nginx&#34;&gt;nginx&lt;/a&gt;、WebUIに&lt;a href=&#34;http://unicorn.bogomips.org/&#34; title=&#34;unicorn&#34;&gt;unicorn&lt;/a&gt;。&lt;a href=&#34;http://www.rabbitmq.com/&#34; title=&#34;RabbitMQ&#34;&gt;RabbitMQ&lt;/a&gt;と&lt;a href=&#34;http://lucene.apache.org/solr/&#34; title=&#34;Solr&#34;&gt;Solr&lt;/a&gt;はそのまま。&lt;/p&gt;

&lt;p&gt;基本的にそのまま使ってて問題ないのだけども、やはりサーバーは壊れるのでバックアップがないと困るよね、ということで調べてもあんまり情報がなかったので、やってみたメモを残します。めんどいのでrootで作業しています。&lt;/p&gt;

&lt;p&gt;&lt;h2&gt;とりあえずinstallする&lt;/h2&gt;
先ほどの&lt;a href=&#34;http://wiki.opscode.com/display/chef/Chef+11+Server+Preview&#34; title=&#34;Chef11&#34;&gt;Chef11&lt;/a&gt;のWikiにある、Quick Startをみて、Platformにあったパッケージをダウンロード。もしくは&lt;a href=&#34;http://www.opscode.com/chef/install/&#34; title=&#34;Install Chef&#34;&gt;Install Chef&lt;/a&gt;というページからダウンロード。Debian6でやりましたが、Ubuntu12用のパッケージではうまく動きませんでしたので、Ubuntu10用のを使いました。11のは知らん。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# wget https://opscode-omnitruck-release.s3.amazonaws.com/ubuntu/10.04/x86_64/chef-server_11.0.6-1.ubuntu.10.04_amd64.deb
# dpkg -i chef-server_11.0.6-1.ubuntu.10.04_amd64.deb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;PrimaryとSecondary、2台のサーバーに入れましょう。&lt;/p&gt;

&lt;p&gt;&lt;h2&gt;PostgreSQLのReplication&lt;/h2&gt;
PostgreSQLはほとんど知らないし、Chef11のパッケージは /opt/chef-server 以下にRubyやGemsやPostgreSQLやその他依存もろもろすっぽり収まって完結しているため、普通にPostgreSQLをinstallした場合とは勝手がちょっと違うので注意が必要です。&lt;/p&gt;

&lt;p&gt;&lt;h3&gt;Primaryの設定&lt;/h3&gt;
設定ファイルは /var/opt/chef-server/postgresql/data 以下にあります。まずアクセス許可。SECONDARY_SERVER_IPADDRESSは任意に読み替えてください。サブネットマスクまで必須です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# echo &amp;quot;host replication repl_user SECONDARY_SERVER_IPADDRESS/0 trust&amp;quot; &amp;gt;&amp;gt; /var/opt/chef-server/postgresql/data/pg_hba.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;次にReplicationの設定。/var/opt/chef-server/postgresql/data/postgresql.conf をエディタで開いて、以下のようにします。hot_standby = onの設定はここでは意味が無いですが、あとでこのファイルがそのままSecondary側にコピーされるのでここで変えておいて問題ないです。
&lt;ul&gt;
    &lt;li&gt;listen_addresses = &amp;lsquo;*&amp;rsquo;&lt;/li&gt;
    &lt;li&gt;wal_level = hot_standby&lt;/li&gt;
    &lt;li&gt;max_wal_senders = 1&lt;/li&gt;
    &lt;li&gt;hot_standby = on&lt;/li&gt;
&lt;/ul&gt;&lt;/p&gt;

&lt;p&gt;次にPostgreSQLのシェルに入ってユーザーを作りますが、opscode-pgsqlユーザーにならないとシェルに入れないので面倒です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# su opscode-pgsql -
$ pgsql postgres -c &amp;quot;CREATE ROLE repl_user LOGIN REPLICATION PASSWORD &#39;P@ssw0Rd&#39;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ここまでやったらPostgreSQLを再起動。Chef11のコンポーネントたちは、daemontoolsの下で動いているので普通には再起動できません。が、専用の管理コマンドが用意されているのでそいつを使います。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# chef-server-ctl restart postgresql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h3&gt;Secondaryの設定&lt;/h3&gt;
Primaryからdebファイルをscpするなりこっちでもwgetするなりして、dpkg -iまでは一緒。installが終わったらPostgreSQLまわりの掃除をします。とりあえず止めて、消す。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# chef-server-ctl stop postgresql
# rm -rf /var/opt/chef-server/postgresql/data
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;消したらPrimaryからデータを持ってきます。PRIMARY_SERVER_IPADDRESSは任意に読み替えてください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# /opt/chef-server/embedded/bin/pg_basebackup -x -p 5432 -h PRIMARY_SERVER_IPADDRESS -U repl_user -W -D /var/opt/chef-server/postgresql/data --progress --verbose
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;終わったらrecovery.confを作ります。sampleからコピって書き換えます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# cp /opt/chef-server/embedded/share/postgresql/recovery.conf.sample /var/opt/chef-server/postgresql/data/recovery.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;/var/opt/chef-server/postgresql/data/recovery.conf で最低限以下のようにいじる。application_nameは別になんでもいいっぽいです。
&lt;ul&gt;
    &lt;li&gt;standby_mode = on&lt;/li&gt;
    &lt;li&gt;primary_conninfo = &amp;lsquo;host=PRIMARY_SERVER_IPADDRESS port=5432 user=repl_user password=P@ssw0Rd application_name=stby&amp;rsquo;&lt;/li&gt;
&lt;/ul&gt;&lt;/p&gt;

&lt;p&gt;あとはrootで作業してしまったのでownerを変えて起動。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# chown -R opscode-pgsql:opscode-pgsql /var/opt/chef-server/postgresql/data
# chef-server-ctl start postgresql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;chef-server-ctl tailでログをみたり、chef-server-ctl statusでpostgresqlがrunになっていることを確認できればOKです。また、Primary側で以下のコマンドを叩くことでも確認できます。stateがstreamingになっていればOK。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo -u opscode-pgsql psql opscode_chef -c &amp;quot;SELECT * FROM pg_stat_replication&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;念のためSolrのindexは作りなおしておいたほうがいいです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# chef-server-ctl reindex
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;h2&gt;切り替える&lt;/h2&gt;
さてフェイルオーバーさせてみます。いくつか方法がありますが、とりあえず手動でやります。Secondary側で、opscode-pgsqlユーザーで操作します。SecondaryはRead-Onlyなので、 CREATE TABLE test (i integer) とかやって失敗→切り替え→もっかいやったら成功、でPrimaryになったことを確認できます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ /opt/chef-server/embedded/bin/pg_ctl promote -D /var/opt/chef-server/postgresql/data
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;こんだけ。また2台構成に戻すには、同じ事をやってやればいいはずです。が、時間経ちすぎてWALファイルがなくなっちゃったとか、転送前にコケてて欠落してるとか、そういう場合はその限りではありません。ていうかそれはChefと関係ないんでそっち方面のマニュアルみるなり調べるなりしてください。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>UbuntuにOpenGrokをinstall</title>
      <link>http://localhost:1313/2013/03/05/974.html</link>
      <pubDate>Tue, 05 Mar 2013 14:36:15 +0900</pubDate>
      
      <guid>http://localhost:1313/2013/03/05/974.html</guid>
      <description>&lt;p&gt;俺メモ&lt;/p&gt;

&lt;p&gt;[sourcecode language=&amp;ldquo;bash&amp;rdquo;]
sudo apt-get update
sudo apt-get install openjdk-6-jdk
sudo apt-get install tomcat7
wget &lt;a href=&#34;http://prdownloads.sourceforge.net/ctags/ctags-5.8.tar.gz&#34;&gt;http://prdownloads.sourceforge.net/ctags/ctags-5.8.tar.gz&lt;/a&gt;
tar xf ctags-5.8.tar.gz
cd ctags-5.8/
./configure &amp;amp;&amp;amp; make &amp;amp;&amp;amp; sudo make install
cd ..
wget &lt;a href=&#34;http://hub.opensolaris.org/bin/download/Project+opengrok/files/opengrok-0.11.1.tar.gz&#34;&gt;http://hub.opensolaris.org/bin/download/Project+opengrok/files/opengrok-0.11.1.tar.gz&lt;/a&gt;
tar xf opengrok-0.11.1.tar.gz
wget &lt;a href=&#34;http://jflex.de/jflex-1.4.3.tar.gz&#34;&gt;http://jflex.de/jflex-1.4.3.tar.gz&lt;/a&gt;
tar xf jflex-1.4.3.tar.gz
cp jflex-1.4.3/lib/JFlex.jar opengrok-0.11.1/lib/lib/
echo &amp;ldquo;export JAVA_HOME=/usr/lib/jvm/java-6-openjdk-amd64&amp;rdquo; &amp;gt;&amp;gt; .bashrc
echo &amp;ldquo;EXUBERANT_CTAGS=/usr/local/bin/ctags&amp;rdquo; &amp;gt;&amp;gt; .bashrc
sudo sed -i &amp;ldquo;s/port=\&amp;ldquo;8080\&amp;ldquo;/port=\&amp;ldquo;2424\&amp;ldquo;/&amp;rdquo; /etc/tomcat7/server.xml
sudo /etc/init.d/tomcat restart
sudo mkdir -p /var/opengrok/{etc,data,src}
sudo chown -R tomcat7:tomcat7 /var/opengrok
sudo chown -R &lt;code&gt;whoami&lt;/code&gt;:&lt;code&gt;whoami&lt;/code&gt; /var/opengrok/src
sudo -u tomcat7 opengrok-0.11/bin/OpenGrok index
sudo -u tomcat7 OPENGROK_TOMCAT_BASE=/var/lib/tomcat7 opengrok-0.11/bin/OpenGrok deploy
```&lt;/p&gt;

&lt;p&gt;あとは /var/opengrok-0.11.1/src に検索対象のソースコード突っ込んでOpenGrok indexし直すだけ。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ChefでRoleやRecipeを実行するとき渡すべき必須のattributesをチェックする</title>
      <link>http://localhost:1313/2013/02/21/959.html</link>
      <pubDate>Thu, 21 Feb 2013 16:06:57 +0900</pubDate>
      
      <guid>http://localhost:1313/2013/02/21/959.html</guid>
      <description>&lt;p&gt;例えばlvsを構築するときに、その下にぶら下がるreal serverたちのIPアドレスとかって、chef-client実行するときに-jオプション使ってjsonでattributes渡して欲しいわけですが、実際に実行する前に必須のものがなければ弾きたい、と思って色々ためした結果&lt;/p&gt;

&lt;p&gt;Roleならjsonに、Recipeならattributes/default.rbに、&lt;strong&gt;required&lt;/strong&gt;とかそういう感じの名前でattributesを作って、そこに配列で指定必須のattributesを並べて書いておく。&lt;/p&gt;

&lt;p&gt;[sourcecode language=&amp;ldquo;javascript&amp;rdquo;]
{
  &amp;ldquo;name&amp;rdquo;: &amp;ldquo;nannchara-kannchara&amp;rdquo;,
  &amp;ldquo;default_attributes&amp;rdquo;: {
  },
  &amp;ldquo;json_class&amp;rdquo;: &amp;ldquo;Chef::Role&amp;rdquo;,
  &amp;ldquo;env_run_lists&amp;rdquo;: {
  },
  &amp;ldquo;run_list&amp;rdquo;: [
    &amp;ldquo;recipe[foo]&amp;ldquo;,
    &amp;ldquo;recipe[bar::baz]&amp;rdquo;
  ],
  &amp;ldquo;description&amp;rdquo;: &amp;ldquo;hogeraccho&amp;rdquo;,
  &amp;ldquo;chef_type&amp;rdquo;: &amp;ldquo;role&amp;rdquo;,
  &amp;ldquo;override_attributes&amp;rdquo;: {
      &amp;ldquo;&lt;strong&gt;required&lt;/strong&gt;&amp;ldquo;: [
        &amp;ldquo;test&amp;rdquo;,
        &amp;ldquo;test1&amp;rdquo;,
        &amp;ldquo;test2&amp;rdquo;
      ]
  }
}&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;
んで knife role from file nannchara-kannchara.json すると、knife search コマンドで取り出せるようになるので、あとは適当に整形すれば一覧として取り出せる

[sourcecode language=&amp;quot;bash&amp;quot;]
$ knife search role -F json -q &amp;quot;name:nannchara-kannchara AND __required__:*&amp;quot; | tr -d &#39;\n&#39; | tr -d &#39; &#39; | grep -oE &amp;quot;required[^]]+&amp;quot; | awk -F[ &#39;{print $2}&#39; | tr &#39;,&#39; &#39;\n&#39; | tr -d &#39;&amp;quot;&#39;
test
test1
test2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;無理やり感があるがまぁ使えるのでよし。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>